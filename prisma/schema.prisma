// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["referentialActions"]
}

model Users {
	@@map(name: "users")
	uid             String @id @default(cuid())

	tokens          Tokens[]

	metadata        UserMetaData?
	projects        Projects[] @relation(name: "members") // A user can have multiple projects.
	ownedProjects   Projects[] @relation(name: "owner")

    roles           String? @default("{}")
}

model UserMetaData {
	@@map(name: "user_metadata")
	uid         Int @id @default(autoincrement())       // id
	user        Users @relation(fields: [userId], references: [uid])
	userId      String
	created_at  DateTime @default(now())
	updated_at  DateTime @updatedAt
	displayName String?
	email       String @unique
	password    String
	firstName   String
	lastName    String
	photoURL    String?
}

model Tokens {
	@@map(name: "tokens")
	uid           Int      @id @default(autoincrement())
	created_at    DateTime  @default(now())
	updated_at    DateTime  @updatedAt
	type          String    // TODO use TokenType when using mysql or postgresql
	hash          String?   @unique // Only used for short lived email tokens
	valid         Boolean   @default(true)
	expiration    DateTime

	// Relation fields
	user          Users @relation(fields: [userId], references: [uid])
	userId        String
}

// TODO uncomment when using mysql or postgresql enum TokenType {
	// EMAIL // used as a short-lived token sent to the user's email
	// API
// }

model Projects {
	@@map(name: "projects")
	uid         String @id @default(cuid())  // Unique ID of the project
	metadata    ProjectMetaData? // Meta data of the project
   	tables      Tables[]

	memberId    String?
	members     Users[] @relation(name: "members", fields: [memberId], references: [uid]) // A project can belong to many members.

	owner       Users? @relation(name: "owner", fields: [ownerId], references: [uid], onUpdate: SetNull, onDelete: SetNull) // TODO rename to Owner in production
    ownerId     String? // Project belongs to a user
}

model ProjectMetaData {
	@@map(name: "project_metadata")
	uid         Int @id @default(autoincrement())       // id
    project     Projects @relation(fields: [projectId], references: [uid])
    projectId   String // Relation to the project.
	created_at  DateTime @default(now())
	updated_at  DateTime @updatedAt
	title       String
	alias       String
	description String
	private     Boolean
	deleted     Boolean
	languages   String

	// Pipeline settings
	version     String
}

model Tables {
	@@map(name: "tables")
    uid         String @id @default(cuid())
    project     Projects @relation(fields: [projectId], references: [uid])
    projectId   String // Relation to the project.
    data        TableData[]
    relations   Relations[]
    revisions   Revisions[]
    metadata    TableMetaData?
}

model TableData {
	@@map(name: "table")
	uid         Int @id @default(autoincrement())       // id
	Table       Tables @relation(fields: [tableId], references: [uid])
	tableId     String
	deleted     Boolean                                 //
	data        String                                  // key value data
}

model TableMetaData {
	uid         Int @id @default(autoincrement())       // id
	Table       Tables @relation(fields: [tableId], references: [uid])
	tableId     String
	title       String
	description String
	lastUID     Int
	created_at  DateTime @default(now())
	updated_at  DateTime @updatedAt
	owner       String
	private     Boolean
	deleted     Boolean

	// Pipeline settings
	version     String
}

// Revisions is versioning for each row in the table.
model Revisions {
	@@map(name: "revisions")
	uid             String @id @default(cuid())
	Table           Tables? @relation(fields: [tableId], references: [uid], onUpdate: SetDefault, onDelete: SetDefault)
	tableId         String? // - tableId - where this revision belongs to.
    currentRevID    Int					            // - CurrentRevID - Current revision of the element
    revision        Int 						    // - Revisions - Rev number of the element
    created_at      DateTime @default(now())		// - created_at - Data changed with the new value
    updated_at      DateTime @updatedAt				// - updated_at - Data changed with the new value
    rowID           Int      						// - Id - Id of the element in that table
    oldValue        String							// - oldValue - old value it got now
    newValue        String	 						// - newValue - new value it had.

    userId          String		 				    // - uid - user id that changed it.
    deleted         Boolean
}

model Relations {
	@@map(name: "relations")
	uid             String @id @default(cuid())
	Table           Tables @relation(fields: [tableId], references: [uid])
	tableId         String                                  // - tableId - where this relation belongs to.
	relationName    String                                  // The relational column name of the table.
	columns         String                                  // Relational data.
}
